<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charSet="utf-8">
    <script>
      'use strict';
      class FilterSortTable {
	  constructor(tableNode, filterBox, nResultBox,
		      showHideCheckboxes) {
	      this.tableNode = tableNode;
	      this.sortKey = null;
	      this.sortAsc = true;
	      this.table = [...this.tableNode.querySelectorAll('tbody tr')]
		  .map( a => ({
		      line: a,
		      content: [...a.querySelectorAll('td')]
			  .map(b =>
			      ((c => c && c.textContent
			      )(b.querySelector('.hidden-content')) ||
				  b.textContent || b.innerText
			      ).normalize('NFD').replace(/[\u0300-\u036f]/g, '')
			  ),
		  }));
	      this.nResultBox = nResultBox;
	      this.filterBox = filterBox;
	      this.filterBox.addEventListener('keyup', a => this.filter());

	      var th = [...this.tableNode.querySelectorAll('thead  th')];
	      for (let i = 0; i < th.length; i++) {
		  th[i].addEventListener('click', a => this.sort(i));
	      }

	      this.filter();

	      this.showHideCheckboxes = [... showHideCheckboxes];
	      this.showHideCheckboxes.forEach(cb => {
		  cb.addEventListener('click', a => this.showHide(cb));
		  this.showHide(cb);
	      });
	  }

	  sort(key) {
	      if (key != this.sortKey) {
		  this.sortAsc = true;
	      }
	      const compare = (f =>
		  this.sortAsc ? ((a,b) => f(a,b)) : ((a,b) => f(b,a))
	      )(
		  (a, b) => a.content[key].localeCompare(b.content[key])
	      );
	      this.table.sort(compare);

	      this.table.forEach( a =>
		  this.tableNode.appendChild(a.line));

	      this.sortKey = key;
	      this.sortAsc = !this.sortAsc;
	  }

	  filter() {
	      const lineMatch = (content, filter) => filter.every(
		  b => content.some(
		      a => a.toUpperCase().indexOf(b) > -1));

	      const filter = this.filterBox.value
		    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
		    .toUpperCase().trim().split(" ");
	      var nResult = 0;
	      this.table.forEach(a => {
		  if (lineMatch(a.content, filter)) {
		      a.line.style.display = "";
		      nResult++;
		  } else {
		      a.line.style.display = "none";
		  }
	      });
	      this.nResultBox.innerText = nResult.toString();
	  }

	  showHide(checkBox) {
	      const disp = checkBox.checked ? "" : "none";
	      this.tableNode.querySelectorAll("." + checkBox.id)
		  .forEach(a => a.style.display = disp);
	  }

      }


      function onLoad() {
	  new FilterSortTable(document.getElementById("bibtable"),
			      document.getElementById("myInput"),
			      document.getElementById("result-number"),
			      document.querySelectorAll("#show-hide-checkboxes input")
			     );
      }
    </script>
    <style>
      .hidden-content {
	  display: none;
      }
    </style>
    <title>Bibliography</title>
  </head>
  <body onload="onLoad();">
    <input type="text" id="myInput">
    <span id="result-info">
      No. of entries: <span id="result-number"></span>.
    </span>

    <span id="show-hide-checkboxes">
      Show: 
      <label for="key"><input type="checkbox" id="key" class="show-hide">Key</label>
      <label for="type"><input type="checkbox" id="type" class="show-hide">Type</label>
      <label for="date"><input type="checkbox" id="date" class="show-hide">Date</label>
    </span>
    <table id="bibtable">
      <thead>
      <tr class="header">
	<th class="key" style="width:4%;">Key</th>
	<th class="type" style="width:4%;">type</th>
	<th class="date" style="width:4%;">Date</th>
	<th class="author" style="width:20%;">Author</th>
	<th style="width:50%;">Title</th>
	<th style="width:20%;">Journal</th>
      </tr>
      </thead>
      <tbody>
      {% for entry in biblio %}
      <tr class="body">
	<td class="key">{{ entry.key or '' }}</td>
	<td class="type">{{ entry.bib_type or '' }}</td>
	<td class="date">{{ entry.date or '' }}</td>
	<td class="author">
	  {% for author in entry.author_list[:-1] %}
	  {{ author.name[0:1] }}.
	  {{ author.surname }},
	  {% endfor %}
	  {{ entry.author_list[-1].name[0:1] }}.
	  {{ entry.author_list[-1].surname }}
	  <span class="hidden-content">
	  {% for author in entry.author_list %}
	  {{ author.surname }}
	  {{ author.name }}
	  {% endfor %}
	  </span>
	</td>
	<td class="title">
	  {% if entry.file %}
	  <a href="{{ entry.file|urlencode }}">{{ entry.title }}</a>
	  {% else %}{{ entry.title }}{% endif %}
	</td>
	<td class="journal">
	  {% if entry.url %}
	  <a href="{{ entry.url }}">{{ entry.journal or entry.note or '' }}</a>
	  {% elif entry.doi %}
	  <a href="https://doi.org/{{ entry.doi|urlencode }}">{{ entry.journal or entry.note or '' }}</a>
	  {% else %}
	  {{ entry.journal or entry.note or '' }}
	  {% endif %}
	</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </body>
</html>
